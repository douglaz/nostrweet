name: Check Nix Updates

on:
  schedule:
    # Run every Monday at 09:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
  push:
    branches: [master]
    paths:
      - 'flake.lock'
      - '.github/workflows/check-nix-updates.yml'
  pull_request:
    paths:
      - 'flake.lock'
      - 'flake.nix'

jobs:
  check-flake:
    name: Check Flake Health
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check flake
        uses: DeterminateSystems/flake-checker-action@v9
        with:
          fail-mode: false  # Don't fail the workflow, just report
          send-statistics: false  # Don't send telemetry

  check-updates:
    name: Check for Updates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v9

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v2

      - name: Check for updates manually
        run: |
          echo "üîç Checking for Nix flake updates..."
          
          # Save current lock file
          cp flake.lock flake.lock.original
          
          # Try updating
          nix flake update
          
          # Check if anything changed
          if ! cmp -s flake.lock flake.lock.original; then
            echo "üì¶ Updates are available!"
            echo ""
            echo "To see what changed, run:"
            echo '```bash'
            echo 'git diff flake.lock'
            echo '```'
            echo ""
            echo "### How to update:"
            echo '```bash'
            echo 'nix flake update'
            echo 'git add flake.lock'
            echo 'git commit -m "chore: update Nix flake dependencies"'
            echo '```'
            
            # Restore original to avoid committing changes
            mv flake.lock.original flake.lock
          else
            echo "‚úÖ All Nix flake inputs are up to date!"
            rm flake.lock.original
          fi

      - name: Test current flake
        run: |
          echo "üß™ Testing current flake configuration..."
          nix flake check
          echo "‚úÖ Flake check passed"